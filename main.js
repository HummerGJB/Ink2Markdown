"use strict";var v=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var V=(n,t)=>{for(var e in t)v(n,e,{get:t[e],enumerable:!0})},j=(n,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of U(t))!K.call(n,i)&&i!==e&&v(n,i,{get:()=>t[i],enumerable:!(s=B(t,i))||s.enumerable});return n};var F=n=>j(v({},"__esModule",{value:!0}),n);var ct={};V(ct,{default:()=>f});module.exports=F(ct);var a=require("obsidian"),I="Role: You are an OCR + formatting engine. Your job is to transcribe handwritten/printed notes into valid Obsidian-compatible Markdown with maximum accuracy. Output only Markdown. Do not add commentary.",C=`Task: Transcribe the provided page image into clean, normalized Markdown for Obsidian.
Rules (follow strictly):
1. Output only Markdown (no code fences, no explanations).
2. Normalize: if the author wrote Markdown syntax imperfectly but intent is clear, output the correct Markdown.
3. Headings: Only treat headings as headings when the author wrote leading # marks (#, ##, ###, etc.). Do not infer headings from underline/boxing.
4. Bullets & numbering: Detect bullet and numbered lists even if written as 1), 1., or 1 etc.
5. Indentation: Infer nested lists from visual indentation.
6. Checkboxes: Treat drawn checkboxes or [ ] / [x] as Markdown task items (- [ ] / - [x]).
7. Underlines: Ignore underline as a formatting signal (do not convert underlines into emphasis/highlight).
8. Line breaks: Prefer semantic paragraphs; do not preserve arbitrary line breaks from handwriting if it\u2019s clearly the same sentence.
9. Illegible text: If any word/phrase is unreadable, insert exactly ==ILLEGIBLE== in its place.
10. No extras: Do not invent tags, links, callouts, or tables. Do not summarize.`,M=`You will be given multiple chunks of Markdown transcribed from sequential pages of the same note.
Goal: Produce a single, continuous, cleaned-up Markdown note with consistent formatting.
Rules:
1. Only output Markdown.
2. Preserve the author\u2019s wording. You may correct obvious OCR mistakes only when the surrounding context makes the correction highly confident.
3. Fix list continuity, indentation, and numbering.
4. Merge sentences split across page boundaries.
5. Prefer semantic paragraphs.
6. Do not add page separators.
7. Preserve ==ILLEGIBLE== markers as-is.`,Y=["gpt-5.2","gpt-5.2-pro","gpt-5.2-chat-latest","gpt-5.1","gpt-5","gpt-5-mini","gpt-5-nano","gpt-5-chat-latest"],q={provider:"openai",systemPrompt:I,extractionPrompt:C,cleanupPrompt:M,openaiApiKey:"",openaiModel:"gpt-5.2",azureEndpoint:"",azureDeployment:"",azureApiVersion:"",azureApiKey:""},G=3,H=6e4,W={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/webp",gif:"image/gif",heic:"image/heic",heif:"image/heif",tif:"image/tiff",tiff:"image/tiff",bmp:"image/bmp"},u=class extends Error{constructor(){super("Ink2Markdown cancelled")}},g=class extends Error{constructor(t,e,s){super(e),this.provider=t,this.status=s}},A=class{constructor(){this.cancelled=!1;this.controllers=new Set}cancel(){this.cancelled=!0;for(let t of this.controllers)t.abort();this.controllers.clear()}register(t){if(this.cancelled){t.abort();return}this.controllers.add(t)}unregister(t){this.controllers.delete(t)}},x=class extends a.Modal{constructor(t,e,s){super(t),this.total=e,this.token=s}onOpen(){let{contentEl:t}=this;t.addClass("ink2markdown-progress"),this.statusEl=t.createEl("div",{cls:"ink2markdown-status",text:"Starting..."}),this.progressEl=t.createEl("progress",{cls:"ink2markdown-progressbar"}),this.progressEl.max=100,this.progressEl.value=0,this.cancelButton=t.createEl("button",{text:"Cancel",cls:"mod-warning"}),this.cancelButton.addEventListener("click",()=>{this.cancelButton.disabled=!0,this.setStatus("Cancelling..."),this.token.cancel()})}onClose(){this.contentEl.empty()}setStatus(t){this.statusEl.setText(t)}setProgress(t){let e=this.total===0?0:Math.round(t/this.total*100);this.progressEl.value=e}},y=class extends a.Modal{constructor(e,s){super(e);this.resolved=!1;this.resolve=s}onOpen(){let{contentEl:e}=this;e.addClass("ink2markdown-disclosure"),e.createEl("h2",{text:"Ink2Markdown Privacy Disclosure"}),e.createEl("p",{text:"Ink2Markdown sends your embedded note images to the configured AI provider for transcription."}),e.createEl("p",{text:"Do not use with sensitive/confidential information unless you accept this."});let s=e.createEl("div",{cls:"ink2markdown-buttons"}),i=s.createEl("button",{text:"I Understand",cls:"mod-cta"}),r=s.createEl("button",{text:"Cancel"});i.addEventListener("click",()=>this.finish(!0)),r.addEventListener("click",()=>this.finish(!1))}onClose(){this.resolved||this.finish(!1)}finish(e){this.resolved||(this.resolved=!0,this.resolve(e),this.close())}},k=class{constructor(t){this.apiKey=t.openaiApiKey.trim(),this.model=t.openaiModel.trim()}async transcribePage(t,e,s){let i={model:this.model,instructions:e.systemPrompt,input:[{role:"user",content:[{type:"input_text",text:e.extractionPrompt},{type:"input_image",image_url:t}]}]},r=await w("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"openai");return T(r)}async cleanup(t,e,s){let i={model:this.model,instructions:e.systemPrompt,input:[{role:"user",content:[{type:"input_text",text:e.cleanupPrompt},{type:"input_text",text:t}]}]},r=await w("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"openai");return T(r)}},b=class{constructor(t){this.endpoint=t.azureEndpoint.trim().replace(/\/+$/,""),this.deployment=t.azureDeployment.trim(),this.apiVersion=t.azureApiVersion.trim(),this.apiKey=t.azureApiKey.trim()}async transcribePage(t,e,s){let i={messages:[{role:"system",content:e.systemPrompt},{role:"user",content:[{type:"text",text:e.extractionPrompt},{type:"image_url",image_url:{url:t}}]}]},r=await w(`${this.endpoint}/openai/deployments/${encodeURIComponent(this.deployment)}/chat/completions?api-version=${encodeURIComponent(this.apiVersion)}`,{method:"POST",headers:{"api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"azure");return S(r)}async cleanup(t,e,s){let i={messages:[{role:"system",content:e.systemPrompt},{role:"user",content:[{type:"text",text:`${e.cleanupPrompt}

${t}`}]}]},r=await w(`${this.endpoint}/openai/deployments/${encodeURIComponent(this.deployment)}/chat/completions?api-version=${encodeURIComponent(this.apiVersion)}`,{method:"POST",headers:{"api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"azure");return S(r)}},f=class extends a.Plugin{async onload(){await this.loadSettings(),this.addCommand({id:"ink2markdown-convert",name:"Ink2Markdown: Convert embedded images to Markdown",callback:()=>this.runConversion()}),this.addSettingTab(new E(this.app,this))}async runConversion(){let t=this.app.workspace.getActiveFile();if(!t){new a.Notice("No active note found.");return}let e=await this.app.vault.read(t),s=X(e);if(s.length===0){new a.Notice("No embedded images found in note.");return}let i=J(this.settings);if(i){new a.Notice(i);return}if(!await this.ensurePrivacyAccepted())return;let o={systemPrompt:this.settings.systemPrompt,extractionPrompt:this.settings.extractionPrompt,cleanupPrompt:this.settings.cleanupPrompt},c=this.settings.provider==="openai"?new k(this.settings):new b(this.settings),p=new A,l=new x(this.app,s.length,p);l.open();try{let d=0;l.setProgress(d);let h=s.map(($,L)=>async()=>{if(p.cancelled)throw new u;l.setStatus(`Processing image ${L+1} of ${s.length}...`);let N=await this.loadImageDataUrl(t,$.linkpath),_=await c.transcribePage(N,o,p);return d+=1,l.setProgress(d),_}),m=await nt(h,G,p);if(p.cancelled)throw new u;l.setStatus("Final formatting cleanup...");let O=m.join(`

`),D=await c.cleanup(O,o,p);if(p.cancelled)throw new u;let R=ot(e,D.trimEnd());await this.app.vault.modify(t,R),l.close(),new a.Notice("Inserted Markdown transcription at top of note.")}catch(d){p.cancel(),l.close(),new a.Notice(at(d))}}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},q,t)}async saveSettings(){await this.saveData(this.settings)}async ensurePrivacyAccepted(){if(this.settings.privacyAcceptedAt)return!0;let t=await new Promise(e=>{new y(this.app,e).open()});return t&&(this.settings.privacyAcceptedAt=Date.now(),await this.saveSettings()),t}async loadImageDataUrl(t,e){if(tt(e))throw new Error("Embedded image must be a local vault file.");let s=this.app.metadataCache.getFirstLinkpathDest(e,t.path);if(!s)throw new Error(`Image not found in vault: ${e}`);let i=s.extension.toLowerCase(),r=W[i];if(!r)throw new Error(`Unsupported image format: .${i}`);let o=await this.app.vault.readBinary(s),c=et(o);return`data:${r};base64,${c}`}},E=class extends a.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Ink2Markdown Settings"}),new a.Setting(t).setName("Provider").setDesc("Choose OpenAI or Azure OpenAI.").addDropdown(i=>{i.addOption("openai","OpenAI").addOption("azure","Azure OpenAI").setValue(this.plugin.settings.provider).onChange(async r=>{this.plugin.settings.provider=r,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.provider==="openai"&&(new a.Setting(t).setName("OpenAI API key").setDesc("Stored locally in plaintext as requested.").addText(i=>{i.inputEl.type="password",i.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async r=>{this.plugin.settings.openaiApiKey=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("OpenAI model").setDesc("GPT-5 family models that support image input.").addDropdown(i=>{for(let r of Y)i.addOption(r,r);i.setValue(this.plugin.settings.openaiModel).onChange(async r=>{this.plugin.settings.openaiModel=r,await this.plugin.saveSettings()})})),this.plugin.settings.provider==="azure"&&(new a.Setting(t).setName("Azure endpoint").setDesc("Example: https://{resource}.openai.azure.com").addText(i=>{i.setPlaceholder("https://example.openai.azure.com").setValue(this.plugin.settings.azureEndpoint).onChange(async r=>{this.plugin.settings.azureEndpoint=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("Azure deployment name").setDesc("Vision-enabled deployment name").addText(i=>{i.setPlaceholder("deployment-name").setValue(this.plugin.settings.azureDeployment).onChange(async r=>{this.plugin.settings.azureDeployment=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("Azure API version").setDesc("Example: 2024-02-15-preview").addText(i=>{i.setPlaceholder("2024-02-15-preview").setValue(this.plugin.settings.azureApiVersion).onChange(async r=>{this.plugin.settings.azureApiVersion=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("Azure API key").setDesc("Stored locally in plaintext as requested.").addText(i=>{i.inputEl.type="password",i.setPlaceholder("azure-key").setValue(this.plugin.settings.azureApiKey).onChange(async r=>{this.plugin.settings.azureApiKey=r.trim(),await this.plugin.saveSettings()})})),t.createEl("h3",{text:"Prompts"}),P(t,"System prompt","Shared system prompt for extraction and cleanup.",this.plugin.settings.systemPrompt,async i=>{this.plugin.settings.systemPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.systemPrompt=I,await this.plugin.saveSettings(),this.display()},"Reset System Prompt"),P(t,"Extraction prompt","Prompt used for per-page transcription.",this.plugin.settings.extractionPrompt,async i=>{this.plugin.settings.extractionPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.extractionPrompt=C,await this.plugin.saveSettings(),this.display()},"Reset Extraction Prompt"),P(t,"Cleanup prompt","Prompt used for final formatting cleanup.",this.plugin.settings.cleanupPrompt,async i=>{this.plugin.settings.cleanupPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.cleanupPrompt=M,await this.plugin.saveSettings(),this.display()},"Reset Cleanup Prompt"),t.createEl("h3",{text:"Privacy disclosure"});let e=this.plugin.settings.privacyAcceptedAt,s=e?`Accepted on ${new Date(e).toLocaleString()}`:"Not accepted";new a.Setting(t).setName("Disclosure status").setDesc(s).addButton(i=>{i.setButtonText("Review disclosure").onClick(async()=>{await new Promise(o=>{new y(this.app,o).open()})&&!this.plugin.settings.privacyAcceptedAt&&(this.plugin.settings.privacyAcceptedAt=Date.now(),await this.plugin.saveSettings(),this.display())})})}};function P(n,t,e,s,i,r,o){let c=new a.Setting(n).setName(t).setDesc(e);c.addTextArea(p=>{p.setValue(s).onChange(async l=>{await i(l)}),p.inputEl.rows=6}),c.addButton(p=>{p.setButtonText(o).onClick(async()=>{await r()})})}function J(n){if(n.provider==="openai"){if(!n.openaiApiKey.trim())return"Missing OpenAI API key.";if(!n.openaiModel.trim())return"Missing OpenAI model selection."}else{if(!n.azureEndpoint.trim())return"Missing Azure endpoint.";if(!n.azureDeployment.trim())return"Missing Azure deployment name.";if(!n.azureApiVersion.trim())return"Missing Azure API version.";if(!n.azureApiKey.trim())return"Missing Azure API key."}return null}function X(n){let t=[],e=/!\[\[([^\]]+)\]\]|!\[[^\]]*\]\(([^)]+)\)/g,s;for(;(s=e.exec(n))!==null;){let i=s[1],r=s[2];if(i){let o=Q(i);o&&t.push({linkpath:o});continue}if(r){let o=Z(r);o&&t.push({linkpath:o})}}return t}function Q(n){let t=n.trim(),e=t.indexOf("|");return e!==-1&&(t=t.slice(0,e)),t=z(t),t.trim()}function Z(n){let t=n.trim();t.startsWith("<")&&t.endsWith(">")&&(t=t.slice(1,-1));let e=t.match(/^(.*?)(\s+["'].*["'])$/);return e&&(t=e[1]),t=z(t),t.trim()}function z(n){let t=n.indexOf("#");t!==-1&&(n=n.slice(0,t));let e=n.indexOf("^");return e!==-1&&(n=n.slice(0,e)),n}function tt(n){return/^(https?:\/\/|data:|app:|obsidian:)/i.test(n.trim())}function et(n){if(typeof Buffer!="undefined")return Buffer.from(n).toString("base64");let t="",e=new Uint8Array(n),s=32768;for(let i=0;i<e.length;i+=s)t+=String.fromCharCode(...e.subarray(i,i+s));return btoa(t)}async function nt(n,t,e){let s=new Array(n.length),i=0,r=0,o=0,c=!1;return new Promise((p,l)=>{let d=()=>{if(!c){if(e.cancelled){c=!0,l(new u);return}for(;i<t&&r<n.length;){let h=r++;i+=1,n[h]().then(m=>{s[h]=m,o+=1}).catch(m=>{c||(c=!0,e.cancel(),l(m))}).finally(()=>{i-=1,c||(o===n.length?p(s):d())})}}};d()})}async function w(n,t,e,s){let r=null;for(let o=1;o<=2;o+=1)try{return await it(n,t,e,s)}catch(c){if(r=c,e.cancelled)throw new u;if(c instanceof g){if(!rt(c.status)||o===2)throw c}else if(o===2)throw c}throw r}async function it(n,t,e,s){let i=new AbortController,r=globalThis.setTimeout(()=>i.abort(),H);e.register(i);try{let o=await fetch(n,{...t,signal:i.signal});if(!o.ok){let c=await st(o);throw new g(s,c||`${s.toUpperCase()} error (${o.status}).`,o.status)}return await o.json()}catch(o){throw e.cancelled?new u:o instanceof g?o:o.name==="AbortError"?new g(s,"Request timed out."):new g(s,"Network error while contacting provider.")}finally{globalThis.clearTimeout(r),e.unregister(i)}}async function st(n){var t;try{let e=await n.json();if((t=e==null?void 0:e.error)!=null&&t.message)return e.error.message;if(e!=null&&e.message)return e.message}catch(e){return null}return null}function rt(n){return n?n===429||n>=500:!0}function T(n){if(typeof(n==null?void 0:n.output_text)=="string")return n.output_text;if(!Array.isArray(n==null?void 0:n.output))throw new Error("OpenAI response did not include output text.");let t=[];for(let s of n.output)if((s==null?void 0:s.type)==="message"&&Array.isArray(s.content))for(let i of s.content)(i==null?void 0:i.type)==="output_text"&&typeof i.text=="string"&&t.push(i.text);let e=t.join("");if(!e)throw new Error("OpenAI response did not include output text.");return e}function S(n){var e,s,i;let t=(i=(s=(e=n==null?void 0:n.choices)==null?void 0:e[0])==null?void 0:s.message)==null?void 0:i.content;if(typeof t!="string")throw new Error("Azure response did not include output text.");return t}function ot(n,t){let e=t.trimEnd();if(!e)return n;let s=n.match(/^---\r?\n[\s\S]*?\r?\n---\r?\n?/);if(!s)return`${e}

${n}`;let i=s[0],r=n.slice(i.length),o=r.startsWith(`
`)?`
`:`

`;return`${i}${e}${o}${r}`}function at(n){if(n instanceof u)return"Ink2Markdown cancelled.";if(n instanceof g){let t=n.status?` (HTTP ${n.status})`:"";return`${n.provider==="openai"?"OpenAI":"Azure OpenAI"} error${t}: ${n.message}`}return n instanceof Error&&n.message||"Unexpected error."}
