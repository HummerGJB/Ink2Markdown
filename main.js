"use strict";var A=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var Y=(n,t)=>{for(var e in t)A(n,e,{get:t[e],enumerable:!0})},G=(n,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of q(t))!W.call(n,i)&&i!==e&&A(n,i,{get:()=>t[i],enumerable:!(s=J(t,i))||s.enumerable});return n};var X=n=>G(A({},"__esModule",{value:!0}),n);var yt={};Y(yt,{default:()=>b});module.exports=X(yt);var a=require("obsidian"),B="Role: You are an OCR + formatting engine. Your job is to transcribe handwritten/printed notes into valid Obsidian-compatible Markdown with maximum accuracy. Output only Markdown. Do not add commentary.",R=`Task: Transcribe the provided page image into clean, normalized Markdown for Obsidian.
Rules (follow strictly):
1. Output only Markdown (no code fences, no explanations).
2. Normalize: if the author wrote Markdown syntax imperfectly but intent is clear, output the correct Markdown.
3. Headings: Treat headings when the author wrote leading # marks (#, ##, ###, etc.). Do not infer headings from underlines.
4. Bullets & numbering: Detect bullet and numbered lists even if written as 1), 1., or 1 etc.
5. Indentation: Infer nested lists from visual indentation.
6. Checkboxes: Treat drawn checkboxes or [ ] / [x] as Markdown task items (- [ ] / - [x]).
7. Highlights: Preserve ==highlight== syntax only when the author explicitly wrote ==...==.
8. Horizontal rules: A straight line spanning at least ~50% of the page width should become a Markdown horizontal rule: ---.
9. Line breaks: Prefer semantic paragraphs; do not preserve arbitrary line breaks from handwriting if it\u2019s clearly the same sentence.
10. Illegible text: If any word/phrase is unreadable, insert exactly ==ILLEGIBLE== in its place.
11. No extras: Do not invent tags, links, callouts, or tables. Do not summarize.`,L=`You will be given multiple chunks of Markdown transcribed from sequential pages of the same note.
Goal: Produce a single, continuous, cleaned-up Markdown note with consistent formatting.
Rules:
1. Only output Markdown.
2. Preserve the author\u2019s wording. You may correct obvious OCR mistakes only when the surrounding context makes the correction highly confident.
3. Fix list continuity, indentation, and numbering.
4. Merge sentences split across page boundaries.
5. Prefer semantic paragraphs.
6. Do not add page separators.
7. Preserve ==ILLEGIBLE== markers as-is.`,N=`You generate concise, descriptive note titles.
Given the full note content, return a short title (3-6 words) that captures the main topic.
Output only the title text with no quotes, no punctuation at the end, and no extra commentary.`,Q=["gpt-5.2","gpt-5.2-pro","gpt-5.2-chat-latest","gpt-5.1","gpt-5","gpt-5-mini","gpt-5-nano","gpt-5-chat-latest"],Z={provider:"openai",systemPrompt:B,extractionPrompt:R,cleanupPrompt:L,titlePrompt:N,openaiApiKey:"",openaiModel:"gpt-5.2",azureEndpoint:"",azureDeployment:"",azureApiVersion:"",azureApiKey:""},tt=3,et=6e4,nt={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/webp",gif:"image/gif",heic:"image/heic",heif:"image/heif",tif:"image/tiff",tiff:"image/tiff",bmp:"image/bmp"},m=class extends Error{constructor(){super("Ink2Markdown cancelled")}},g=class extends Error{constructor(t,e,s){super(e),this.provider=t,this.status=s}},y=class{constructor(){this.cancelled=!1;this.controllers=new Set}cancel(){this.cancelled=!0;for(let t of this.controllers)t.abort();this.controllers.clear()}register(t){if(this.cancelled){t.abort();return}this.controllers.add(t)}unregister(t){this.controllers.delete(t)}},I=class extends a.Modal{constructor(t,e,s){super(t),this.total=e,this.token=s}onOpen(){let{contentEl:t}=this;t.addClass("ink2markdown-progress"),this.statusEl=t.createEl("div",{cls:"ink2markdown-status",text:"Starting..."}),this.progressEl=t.createEl("progress",{cls:"ink2markdown-progressbar"}),this.progressEl.max=100,this.progressEl.value=0,this.cancelButton=t.createEl("button",{text:"Cancel",cls:"mod-warning"}),this.cancelButton.addEventListener("click",()=>{this.cancelButton.disabled=!0,this.setStatus("Cancelling..."),this.token.cancel()})}onClose(){this.contentEl.empty()}setStatus(t){this.statusEl.setText(t)}setProgress(t){let e=this.total===0?0:Math.round(t/this.total*100);this.progressEl.value=e}},k=class extends a.Modal{constructor(e,s){super(e);this.resolved=!1;this.resolve=s}onOpen(){let{contentEl:e}=this;e.addClass("ink2markdown-disclosure"),e.createEl("h2",{text:"Ink2Markdown Privacy Disclosure"}),e.createEl("p",{text:"Ink2Markdown sends your embedded note images to the configured AI provider for transcription."}),e.createEl("p",{text:"Do not use with sensitive/confidential information unless you accept this."});let s=e.createEl("div",{cls:"ink2markdown-buttons"}),i=s.createEl("button",{text:"I Understand",cls:"mod-cta"}),r=s.createEl("button",{text:"Cancel"});i.addEventListener("click",()=>this.finish(!0)),r.addEventListener("click",()=>this.finish(!1))}onClose(){this.resolved||this.finish(!1)}finish(e){this.resolved||(this.resolved=!0,this.resolve(e),this.close())}},M=class extends a.Modal{constructor(e,s,i){super(e);this.resolved=!1;this.captured=0;this.processing=!1;this.autoTitle=!1;this.onCapture=s,this.resolve=i}onOpen(){let{contentEl:e}=this;e.addClass("ink2markdown-capture"),e.createEl("h2",{text:"Capture note pages"}),e.createEl("p",{text:"Photos will be added to the bottom of the current note."}),this.statusEl=e.createEl("div",{cls:"ink2markdown-capture-status",text:"No photos captured yet."});let s=e.createEl("label",{cls:"ink2markdown-capture-option"}),i=s.createEl("input",{type:"checkbox"});s.createSpan({text:"Auto-generate title with AI"}),i.addEventListener("change",()=>{this.autoTitle=i.checked});let r=e.createEl("div",{cls:"ink2markdown-buttons"});this.takeButton=r.createEl("button",{text:"Take photo",cls:"mod-cta"}),this.doneButton=r.createEl("button",{text:"Done"}),this.cancelButton=r.createEl("button",{text:"Cancel"}),this.takeButton.addEventListener("click",()=>{this.processing||this.startCapture()}),this.doneButton.addEventListener("click",()=>{this.finish("done")}),this.cancelButton.addEventListener("click",()=>{this.finish("cancel")}),window.setTimeout(()=>{this.processing||this.startCapture()},0)}onClose(){this.contentEl.empty(),this.resolved||this.finish("cancel")}startCapture(){let e=this.contentEl.createEl("input");e.type="file",e.accept="image/*",e.setAttribute("capture","environment"),e.style.display="none",e.addEventListener("change",()=>{this.handleSelection(e)});try{e.click()}catch(s){e.remove()}}async handleSelection(e){var i;if(this.processing){e.remove();return}let s=(i=e.files)==null?void 0:i[0];if(e.value="",e.remove(),!!s){this.processing=!0,this.setButtonsDisabled(!0),this.setStatus("Saving photo...");try{await this.onCapture(s,this.captured+1),this.captured+=1,this.setStatus(`${this.captured} photo${this.captured===1?"":"s"} captured.`)}catch(r){let o=r instanceof Error&&r.message?r.message:"Failed to save photo.";new a.Notice(o),this.setStatus("Could not save that photo.")}finally{this.processing=!1,this.setButtonsDisabled(!1)}}}setButtonsDisabled(e){this.takeButton.disabled=e,this.doneButton.disabled=e,this.cancelButton.disabled=e}setStatus(e){this.statusEl.setText(e)}finish(e){this.resolved||(this.resolved=!0,this.resolve({status:e,count:this.captured,autoTitle:this.autoTitle}),this.close())}},w=class{constructor(t){this.apiKey=t.openaiApiKey.trim(),this.model=t.openaiModel.trim()}async transcribePage(t,e,s){let i={model:this.model,instructions:e.systemPrompt,input:[{role:"user",content:[{type:"input_text",text:e.extractionPrompt},{type:"input_image",image_url:t}]}]},r=await f("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"openai");return E(r)}async cleanup(t,e,s){let i={model:this.model,instructions:e.systemPrompt,input:[{role:"user",content:[{type:"input_text",text:e.cleanupPrompt},{type:"input_text",text:t}]}]},r=await f("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"openai");return E(r)}async testConnection(t){let e={model:this.model,input:"ping"};await f("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(e)},t,"openai")}async generateTitle(t,e,s){let i={model:this.model,instructions:e,input:[{role:"user",content:[{type:"input_text",text:t}]}]},r=await f("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"openai");return E(r)}},v=class{constructor(t){this.endpoint=t.azureEndpoint.trim().replace(/\/+$/,""),this.deployment=t.azureDeployment.trim(),this.apiVersion=t.azureApiVersion.trim(),this.apiKey=t.azureApiKey.trim()}async transcribePage(t,e,s){let i={messages:[{role:"system",content:e.systemPrompt},{role:"user",content:[{type:"text",text:e.extractionPrompt},{type:"image_url",image_url:{url:t}}]}]},r=await f(`${this.endpoint}/openai/deployments/${encodeURIComponent(this.deployment)}/chat/completions?api-version=${encodeURIComponent(this.apiVersion)}`,{method:"POST",headers:{"api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"azure");return C(r)}async cleanup(t,e,s){let i={messages:[{role:"system",content:e.systemPrompt},{role:"user",content:[{type:"text",text:`${e.cleanupPrompt}

${t}`}]}]},r=await f(`${this.endpoint}/openai/deployments/${encodeURIComponent(this.deployment)}/chat/completions?api-version=${encodeURIComponent(this.apiVersion)}`,{method:"POST",headers:{"api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"azure");return C(r)}async testConnection(t){let e={messages:[{role:"user",content:"ping"}]};await f(`${this.endpoint}/openai/deployments/${encodeURIComponent(this.deployment)}/chat/completions?api-version=${encodeURIComponent(this.apiVersion)}`,{method:"POST",headers:{"api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify(e)},t,"azure")}async generateTitle(t,e,s){let i={messages:[{role:"system",content:e},{role:"user",content:[{type:"text",text:t}]}]},r=await f(`${this.endpoint}/openai/deployments/${encodeURIComponent(this.deployment)}/chat/completions?api-version=${encodeURIComponent(this.apiVersion)}`,{method:"POST",headers:{"api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"azure");return C(r)}},b=class extends a.Plugin{async onload(){await this.loadSettings(),this.addCommand({id:"ink2markdown-convert",name:"Ink2Markdown: Convert embedded images to Markdown",callback:()=>this.runConversion()}),this.addCommand({id:"ink2markdown-capture-and-convert",name:"Ink2Markdown: Capture images then convert",callback:()=>this.runCaptureAndConvert()}),this.addSettingTab(new $(this.app,this))}async runConversion(){let t=this.app.workspace.getActiveFile();if(!t||t.extension!=="md"){new a.Notice("No active note found.");return}await this.runConversionForFile(t)}async runConversionForFile(t){let e=await this.app.vault.read(t),s=st(e);if(s.length===0)return new a.Notice("No embedded images found in note."),null;let i=x(this.settings);if(i)return new a.Notice(i),null;if(!await this.ensurePrivacyAccepted())return null;let o={systemPrompt:this.settings.systemPrompt,extractionPrompt:this.settings.extractionPrompt,cleanupPrompt:this.settings.cleanupPrompt},c=this.settings.provider==="openai"?new w(this.settings):new v(this.settings),p=new y,l=new I(this.app,s.length,p);l.open();try{let u=0;l.setProgress(u);let d=s.map((K,V)=>async()=>{if(p.cancelled)throw new m;l.setStatus(`Processing image ${V+1} of ${s.length}...`);let j=await this.loadImageDataUrl(t,K.linkpath),H=await c.transcribePage(j,o,p);return u+=1,l.setProgress(u),H}),h=await pt(d,tt,p);if(p.cancelled)throw new m;l.setStatus("Final formatting cleanup...");let T=h.join(`

<<<<<<< HEAD
`),z=await c.cleanup(T,o,p);if(p.cancelled)throw new m;let _=mt(e,z.trimEnd());return await this.app.vault.modify(t,_),l.close(),new a.Notice("Inserted Markdown transcription at top of note."),z.trim()}catch(u){return p.cancel(),l.close(),new a.Notice(S(u)),null}}async runCaptureAndConvert(){let t=this.app.workspace.getActiveFile();if(!t||t.extension!=="md"){new a.Notice("Open a note to capture images.");return}let e=await new Promise(i=>{new M(this.app,(r,o)=>this.saveAndEmbedCapture(t,r,o),i).open()});if(e.status!=="done")return;if(e.count===0){new a.Notice("No photos captured.");return}let s=await this.runConversionForFile(t);e.autoTitle&&s&&await this.generateAndApplyTitle(t,s)}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},Z,t)}async saveSettings(){await this.saveData(this.settings)}async ensurePrivacyAccepted(){if(this.settings.privacyAcceptedAt)return!0;let t=await new Promise(e=>{new k(this.app,e).open()});return t&&(this.settings.privacyAcceptedAt=Date.now(),await this.saveSettings()),t}async loadImageDataUrl(t,e){if(at(e))throw new Error("Embedded image must be a local vault file.");let s=this.app.metadataCache.getFirstLinkpathDest(e,t.path);if(!s)throw new Error(`Image not found in vault: ${e}`);let i=s.extension.toLowerCase(),r=nt[i];if(!r)throw new Error(`Unsupported image format: .${i}`);let o=await this.app.vault.readBinary(s),c=ct(o);return`data:${r};base64,${c}`}async saveAndEmbedCapture(t,e,s){let i=gt(e),o=`Ink Capture ${ht(new Date)}-${String(s).padStart(2,"0")}.${i}`,c=await this.app.fileManager.getAvailablePathForAttachment(o,t.path),p=await e.arrayBuffer(),l=await this.app.vault.createBinary(c,p),u=this.app.fileManager.generateMarkdownLink(l,t.path),d=u.startsWith("!")?u:`!${u}`,h=await this.app.vault.read(t),T=ft(h,d);await this.app.vault.modify(t,T)}async testConnection(){let t=x(this.settings);if(t){new a.Notice(t);return}let e=this.settings.provider==="openai"?new w(this.settings):new v(this.settings),s=new y;try{await e.testConnection(s),new a.Notice("Connection successful.")}catch(i){new a.Notice(S(i))}}async generateAndApplyTitle(t,e){let s=x(this.settings);if(s){new a.Notice(s);return}if(!await this.ensurePrivacyAccepted())return;let r=this.settings.provider==="openai"?new w(this.settings):new v(this.settings),o=new y;try{let c=await r.generateTitle(e,this.settings.titlePrompt,o),p=it(c);if(!p){new a.Notice("AI title generation returned an empty title.");return}let l=this.buildAvailableNotePath(t,p);if(l===t.path)return;await this.app.fileManager.renameFile(t,l),new a.Notice(`Renamed note to "${p}".`)}catch(c){o.cancel(),new a.Notice(S(c))}}buildAvailableNotePath(t,e){var c,p;let s=F(e)||"Untitled",i=(p=(c=t.parent)==null?void 0:c.path)!=null?p:"",r=i?`${i}/${s}.md`:`${s}.md`;if(r===t.path||!this.app.vault.getAbstractFileByPath(r))return r;let o=1;for(;;){let l=i?`${i}/${s} ${o}.md`:`${s} ${o}.md`;if(!this.app.vault.getAbstractFileByPath(l))return l;o+=1}}},$=class extends a.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Ink2Markdown Settings"}),new a.Setting(t).setName("Provider").setDesc("Choose OpenAI or Azure OpenAI.").addDropdown(i=>{i.addOption("openai","OpenAI").addOption("azure","Azure OpenAI").setValue(this.plugin.settings.provider).onChange(async r=>{this.plugin.settings.provider=r,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.provider==="openai"&&(new a.Setting(t).setName("OpenAI API key").setDesc("Stored locally in plaintext as requested.").addText(i=>{i.inputEl.type="password",i.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async r=>{this.plugin.settings.openaiApiKey=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("OpenAI model").setDesc("GPT-5 family models that support image input.").addDropdown(i=>{for(let r of Q)i.addOption(r,r);i.setValue(this.plugin.settings.openaiModel).onChange(async r=>{this.plugin.settings.openaiModel=r,await this.plugin.saveSettings()})})),this.plugin.settings.provider==="azure"&&(new a.Setting(t).setName("Azure endpoint").setDesc("Example: https://{resource}.openai.azure.com").addText(i=>{i.setPlaceholder("https://example.openai.azure.com").setValue(this.plugin.settings.azureEndpoint).onChange(async r=>{this.plugin.settings.azureEndpoint=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("Azure deployment name").setDesc("Vision-enabled deployment name").addText(i=>{i.setPlaceholder("deployment-name").setValue(this.plugin.settings.azureDeployment).onChange(async r=>{this.plugin.settings.azureDeployment=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("Azure API version").setDesc("Example: 2024-02-15-preview").addText(i=>{i.setPlaceholder("2024-02-15-preview").setValue(this.plugin.settings.azureApiVersion).onChange(async r=>{this.plugin.settings.azureApiVersion=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("Azure API key").setDesc("Stored locally in plaintext as requested.").addText(i=>{i.inputEl.type="password",i.setPlaceholder("azure-key").setValue(this.plugin.settings.azureApiKey).onChange(async r=>{this.plugin.settings.azureApiKey=r.trim(),await this.plugin.saveSettings()})})),new a.Setting(t).setName("Test connection").setDesc("Validate your current provider credentials and settings.").addButton(i=>{i.setButtonText("Test connection").onClick(async()=>{i.setDisabled(!0),i.setButtonText("Testing..."),await this.plugin.testConnection(),i.setButtonText("Test connection"),i.setDisabled(!1)})}),t.createEl("h3",{text:"Prompts"}),P(t,"System prompt","Shared system prompt for extraction and cleanup.",this.plugin.settings.systemPrompt,async i=>{this.plugin.settings.systemPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.systemPrompt=B,await this.plugin.saveSettings(),this.display()},"Reset System Prompt"),P(t,"Extraction prompt","Prompt used for per-page transcription.",this.plugin.settings.extractionPrompt,async i=>{this.plugin.settings.extractionPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.extractionPrompt=R,await this.plugin.saveSettings(),this.display()},"Reset Extraction Prompt"),P(t,"Cleanup prompt","Prompt used for final formatting cleanup.",this.plugin.settings.cleanupPrompt,async i=>{this.plugin.settings.cleanupPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.cleanupPrompt=L,await this.plugin.saveSettings(),this.display()},"Reset Cleanup Prompt"),P(t,"Title prompt","Prompt used to generate a short title from the cleaned note.",this.plugin.settings.titlePrompt,async i=>{this.plugin.settings.titlePrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.titlePrompt=N,await this.plugin.saveSettings(),this.display()},"Reset Title Prompt"),t.createEl("h3",{text:"Privacy disclosure"});let e=this.plugin.settings.privacyAcceptedAt,s=e?`Accepted on ${new Date(e).toLocaleString()}`:"Not accepted";new a.Setting(t).setName("Disclosure status").setDesc(s).addButton(i=>{i.setButtonText("Review disclosure").onClick(async()=>{await new Promise(o=>{new k(this.app,o).open()})&&!this.plugin.settings.privacyAcceptedAt&&(this.plugin.settings.privacyAcceptedAt=Date.now(),await this.plugin.saveSettings(),this.display())})})}};function P(n,t,e,s,i,r,o){let c=new a.Setting(n).setName(t).setDesc(e);c.addTextArea(p=>{p.setValue(s).onChange(async l=>{await i(l)}),p.inputEl.rows=6}),c.addButton(p=>{p.setButtonText(o).onClick(async()=>{await r()})})}function x(n){if(n.provider==="openai"){if(!n.openaiApiKey.trim())return"Missing OpenAI API key.";if(!n.openaiModel.trim())return"Missing OpenAI model selection."}else{if(!n.azureEndpoint.trim())return"Missing Azure endpoint.";if(!n.azureDeployment.trim())return"Missing Azure deployment name.";if(!n.azureApiVersion.trim())return"Missing Azure API version.";if(!n.azureApiKey.trim())return"Missing Azure API key."}return null}function it(n){var s,i;let e=((i=(s=n.split(/\r?\n/)[0])==null?void 0:s.trim())!=null?i:"").replace(/^["'“”]+|["'“”]+$/g,"");return F(e)}function F(n){let t=n.replace(/[\\/:*?"<>|]/g,"").replace(/\s+/g," ").trim().replace(/^\.+/,"").replace(/\.+$/,"");return t?t.length>80?t.slice(0,80).trim():t:""}function st(n){let t=[],e=/!\[\[([^\]]+)\]\]|!\[[^\]]*\]\(([^)]+)\)/g,s;for(;(s=e.exec(n))!==null;){let i=s[1],r=s[2];if(i){let o=rt(i);o&&t.push({linkpath:o});continue}if(r){let o=ot(r);o&&t.push({linkpath:o})}}return t}function rt(n){let t=n.trim(),e=t.indexOf("|");return e!==-1&&(t=t.slice(0,e)),t=U(t),t.trim()}function ot(n){let t=n.trim();t.startsWith("<")&&t.endsWith(">")&&(t=t.slice(1,-1));let e=t.match(/^(.*?)(\s+["'].*["'])$/);return e&&(t=e[1]),t=U(t),t.trim()}function U(n){let t=n.indexOf("#");t!==-1&&(n=n.slice(0,t));let e=n.indexOf("^");return e!==-1&&(n=n.slice(0,e)),n}function at(n){return/^(https?:\/\/|data:|app:|obsidian:)/i.test(n.trim())}function ct(n){if(typeof Buffer!="undefined")return Buffer.from(n).toString("base64");let t="",e=new Uint8Array(n),s=32768;for(let i=0;i<e.length;i+=s)t+=String.fromCharCode(...e.subarray(i,i+s));return btoa(t)}async function pt(n,t,e){let s=new Array(n.length),i=0,r=0,o=0,c=!1;return new Promise((p,l)=>{let u=()=>{if(!c){if(e.cancelled){c=!0,l(new m);return}for(;i<t&&r<n.length;){let d=r++;i+=1,n[d]().then(h=>{s[d]=h,o+=1}).catch(h=>{c||(c=!0,e.cancel(),l(h))}).finally(()=>{i-=1,c||(o===n.length?p(s):u())})}}};u()})}async function f(n,t,e,s){let r=null;for(let o=1;o<=2;o+=1)try{return await lt(n,t,e,s)}catch(c){if(r=c,e.cancelled)throw new m;if(c instanceof g){if(!dt(c.status)||o===2)throw c}else if(o===2)throw c}throw r}async function lt(n,t,e,s){var r,o,c;let i=null;try{if(e.cancelled)throw new m;let p=ut(t.headers),l=typeof t.body=="string"?t.body:t.body?String(t.body):void 0,u=await Promise.race([(0,a.requestUrl)({url:n,method:(r=t.method)!=null?r:"GET",headers:p,body:l,throw:!1}),new Promise((d,h)=>{i=setTimeout(()=>{h(new g(s,"Request timed out."))},et)})]);if(e.cancelled)throw new m;if(u.status<200||u.status>=300){let d=(o=D(u.json))!=null?o:D(O(u.text));throw new g(s,d!=null?d:`${s.toUpperCase()} error (${u.status}).`,u.status)}return(c=u.json)!=null?c:O(u.text)}catch(p){throw e.cancelled?new m:p instanceof g?p:p instanceof Error&&/timed out|timeout/i.test(p.message)?new g(s,"Request timed out."):new g(s,"Network error while contacting provider.")}finally{i&&clearTimeout(i)}}function O(n){if(!n)return null;try{return JSON.parse(n)}catch(t){return null}}function D(n){var t;return n?(t=n==null?void 0:n.error)!=null&&t.message?n.error.message:n!=null&&n.message?n.message:null:null}function ut(n){if(!n)return{};if(n instanceof Headers){let t={};return n.forEach((e,s)=>{t[s]=e}),t}return Array.isArray(n)?Object.fromEntries(n):n}function dt(n){return n?n===429||n>=500:!0}function E(n){if(typeof(n==null?void 0:n.output_text)=="string")return n.output_text;if(!Array.isArray(n==null?void 0:n.output))throw new Error("OpenAI response did not include output text.");let t=[];for(let s of n.output)if((s==null?void 0:s.type)==="message"&&Array.isArray(s.content))for(let i of s.content)(i==null?void 0:i.type)==="output_text"&&typeof i.text=="string"&&t.push(i.text);let e=t.join("");if(!e)throw new Error("OpenAI response did not include output text.");return e}function C(n){var e,s,i;let t=(i=(s=(e=n==null?void 0:n.choices)==null?void 0:e[0])==null?void 0:s.message)==null?void 0:i.content;if(typeof t!="string")throw new Error("Azure response did not include output text.");return t}function mt(n,t){let e=t.trimEnd();if(!e)return n;let s=n.match(/^---\r?\n[\s\S]*?\r?\n---\r?\n?/);if(!s)return`${e}
=======
`),N=await c.cleanup(b,o,p);if(p.cancelled)throw new m;let F=lt(e,N.trimEnd());await this.app.vault.modify(t,F),u.close(),new a.Notice("Inserted Markdown transcription at top of note.")}catch(l){p.cancel(),u.close(),new a.Notice(D(l))}}async runCaptureAndConvert(){let t=this.app.workspace.getActiveFile();if(!t||t.extension!=="md"){new a.Notice("Open a note to capture images.");return}let e=await new Promise(s=>{new T(this.app,(i,r)=>this.saveAndEmbedCapture(t,i,r),s).open()});if(e.status==="done"){if(e.count===0){new a.Notice("No photos captured.");return}await this.runConversionForFile(t)}}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},X,t)}async saveSettings(){await this.saveData(this.settings)}async ensurePrivacyAccepted(){if(this.settings.privacyAcceptedAt)return!0;let t=await new Promise(e=>{new w(this.app,e).open()});return t&&(this.settings.privacyAcceptedAt=Date.now(),await this.saveSettings()),t}async loadImageDataUrl(t,e){if(st(e))throw new Error("Embedded image must be a local vault file.");let s=this.app.metadataCache.getFirstLinkpathDest(e,t.path);if(!s)throw new Error(`Image not found in vault: ${e}`);let i=s.extension.toLowerCase(),r=tt[i];if(!r)throw new Error(`Unsupported image format: .${i}`);let o=await this.app.vault.readBinary(s),c=rt(o);return`data:${r};base64,${c}`}async saveAndEmbedCapture(t,e,s){let i=dt(e),o=`Ink2Ccapture ${ut(new Date)}-${String(s).padStart(2,"0")}.${i}`,c=await this.app.fileManager.getAvailablePathForAttachment(o,t.path),p=await e.arrayBuffer(),u=await this.app.vault.createBinary(c,p),l=this.app.fileManager.generateMarkdownLink(u,t.path),d=l.startsWith("!")?l:`!${l}`,h=await this.app.vault.read(t),b=mt(h,d);await this.app.vault.modify(t,b)}async testConnection(){let t=S(this.settings);if(t){new a.Notice(t);return}let e=this.settings.provider==="openai"?new v(this.settings):new P(this.settings),s=new y;try{await e.testConnection(s),new a.Notice("Connection successful.")}catch(i){new a.Notice(D(i))}}},C=class extends a.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Ink2Markdown Settings"}),new a.Setting(t).setName("Provider").setDesc("Choose OpenAI or Azure OpenAI.").addDropdown(i=>{i.addOption("openai","OpenAI").addOption("azure","Azure OpenAI").setValue(this.plugin.settings.provider).onChange(async r=>{this.plugin.settings.provider=r,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.provider==="openai"&&(new a.Setting(t).setName("OpenAI API key").setDesc("Stored locally in plaintext as requested.").addText(i=>{i.inputEl.type="password",i.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async r=>{this.plugin.settings.openaiApiKey=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("OpenAI model").setDesc("GPT-5 family models that support image input.").addDropdown(i=>{for(let r of G)i.addOption(r,r);i.setValue(this.plugin.settings.openaiModel).onChange(async r=>{this.plugin.settings.openaiModel=r,await this.plugin.saveSettings()})})),this.plugin.settings.provider==="azure"&&(new a.Setting(t).setName("Azure endpoint").setDesc("Example: https://{resource}.openai.azure.com").addText(i=>{i.setPlaceholder("https://example.openai.azure.com").setValue(this.plugin.settings.azureEndpoint).onChange(async r=>{this.plugin.settings.azureEndpoint=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("Azure deployment name").setDesc("Vision-enabled deployment name").addText(i=>{i.setPlaceholder("deployment-name").setValue(this.plugin.settings.azureDeployment).onChange(async r=>{this.plugin.settings.azureDeployment=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("Azure API version").setDesc("Example: 2024-02-15-preview").addText(i=>{i.setPlaceholder("2024-02-15-preview").setValue(this.plugin.settings.azureApiVersion).onChange(async r=>{this.plugin.settings.azureApiVersion=r.trim(),await this.plugin.saveSettings()})}),new a.Setting(t).setName("Azure API key").setDesc("Stored locally in plaintext as requested.").addText(i=>{i.inputEl.type="password",i.setPlaceholder("azure-key").setValue(this.plugin.settings.azureApiKey).onChange(async r=>{this.plugin.settings.azureApiKey=r.trim(),await this.plugin.saveSettings()})})),new a.Setting(t).setName("Test connection").setDesc("Validate your current provider credentials and settings.").addButton(i=>{i.setButtonText("Test connection").onClick(async()=>{i.setDisabled(!0),i.setButtonText("Testing..."),await this.plugin.testConnection(),i.setButtonText("Test connection"),i.setDisabled(!1)})}),t.createEl("h3",{text:"Prompts"}),A(t,"System prompt","Shared system prompt for extraction and cleanup.",this.plugin.settings.systemPrompt,async i=>{this.plugin.settings.systemPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.systemPrompt=$,await this.plugin.saveSettings(),this.display()},"Reset System Prompt"),A(t,"Extraction prompt","Prompt used for per-page transcription.",this.plugin.settings.extractionPrompt,async i=>{this.plugin.settings.extractionPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.extractionPrompt=B,await this.plugin.saveSettings(),this.display()},"Reset Extraction Prompt"),A(t,"Cleanup prompt","Prompt used for final formatting cleanup.",this.plugin.settings.cleanupPrompt,async i=>{this.plugin.settings.cleanupPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.cleanupPrompt=R,await this.plugin.saveSettings(),this.display()},"Reset Cleanup Prompt"),t.createEl("h3",{text:"Privacy disclosure"});let e=this.plugin.settings.privacyAcceptedAt,s=e?`Accepted on ${new Date(e).toLocaleString()}`:"Not accepted";new a.Setting(t).setName("Disclosure status").setDesc(s).addButton(i=>{i.setButtonText("Review disclosure").onClick(async()=>{await new Promise(o=>{new w(this.app,o).open()})&&!this.plugin.settings.privacyAcceptedAt&&(this.plugin.settings.privacyAcceptedAt=Date.now(),await this.plugin.saveSettings(),this.display())})})}};function A(n,t,e,s,i,r,o){let c=new a.Setting(n).setName(t).setDesc(e);c.addTextArea(p=>{p.setValue(s).onChange(async u=>{await i(u)}),p.inputEl.rows=6}),c.addButton(p=>{p.setButtonText(o).onClick(async()=>{await r()})})}function S(n){if(n.provider==="openai"){if(!n.openaiApiKey.trim())return"Missing OpenAI API key.";if(!n.openaiModel.trim())return"Missing OpenAI model selection."}else{if(!n.azureEndpoint.trim())return"Missing Azure endpoint.";if(!n.azureDeployment.trim())return"Missing Azure deployment name.";if(!n.azureApiVersion.trim())return"Missing Azure API version.";if(!n.azureApiKey.trim())return"Missing Azure API key."}return null}function et(n){let t=[],e=/!\[\[([^\]]+)\]\]|!\[[^\]]*\]\(([^)]+)\)/g,s;for(;(s=e.exec(n))!==null;){let i=s[1],r=s[2];if(i){let o=nt(i);o&&t.push({linkpath:o});continue}if(r){let o=it(r);o&&t.push({linkpath:o})}}return t}function nt(n){let t=n.trim(),e=t.indexOf("|");return e!==-1&&(t=t.slice(0,e)),t=L(t),t.trim()}function it(n){let t=n.trim();t.startsWith("<")&&t.endsWith(">")&&(t=t.slice(1,-1));let e=t.match(/^(.*?)(\s+["'].*["'])$/);return e&&(t=e[1]),t=L(t),t.trim()}function L(n){let t=n.indexOf("#");t!==-1&&(n=n.slice(0,t));let e=n.indexOf("^");return e!==-1&&(n=n.slice(0,e)),n}function st(n){return/^(https?:\/\/|data:|app:|obsidian:)/i.test(n.trim())}function rt(n){if(typeof Buffer!="undefined")return Buffer.from(n).toString("base64");let t="",e=new Uint8Array(n),s=32768;for(let i=0;i<e.length;i+=s)t+=String.fromCharCode(...e.subarray(i,i+s));return btoa(t)}async function ot(n,t,e){let s=new Array(n.length),i=0,r=0,o=0,c=!1;return new Promise((p,u)=>{let l=()=>{if(!c){if(e.cancelled){c=!0,u(new m);return}for(;i<t&&r<n.length;){let d=r++;i+=1,n[d]().then(h=>{s[d]=h,o+=1}).catch(h=>{c||(c=!0,e.cancel(),u(h))}).finally(()=>{i-=1,c||(o===n.length?p(s):l())})}}};l()})}async function f(n,t,e,s){let r=null;for(let o=1;o<=2;o+=1)try{return await at(n,t,e,s)}catch(c){if(r=c,e.cancelled)throw new m;if(c instanceof g){if(!pt(c.status)||o===2)throw c}else if(o===2)throw c}throw r}async function at(n,t,e,s){var r,o,c;let i=null;try{if(e.cancelled)throw new m;let p=ct(t.headers),u=typeof t.body=="string"?t.body:t.body?String(t.body):void 0,l=await Promise.race([(0,a.requestUrl)({url:n,method:(r=t.method)!=null?r:"GET",headers:p,body:u,throw:!1}),new Promise((d,h)=>{i=setTimeout(()=>{h(new g(s,"Request timed out."))},Z)})]);if(e.cancelled)throw new m;if(l.status<200||l.status>=300){let d=(o=M(l.json))!=null?o:M(I(l.text));throw new g(s,d!=null?d:`${s.toUpperCase()} error (${l.status}).`,l.status)}return(c=l.json)!=null?c:I(l.text)}catch(p){throw e.cancelled?new m:p instanceof g?p:p instanceof Error&&/timed out|timeout/i.test(p.message)?new g(s,"Request timed out."):new g(s,"Network error while contacting provider.")}finally{i&&clearTimeout(i)}}function I(n){if(!n)return null;try{return JSON.parse(n)}catch(t){return null}}function M(n){var t;return n?(t=n==null?void 0:n.error)!=null&&t.message?n.error.message:n!=null&&n.message?n.message:null:null}function ct(n){if(!n)return{};if(n instanceof Headers){let t={};return n.forEach((e,s)=>{t[s]=e}),t}return Array.isArray(n)?Object.fromEntries(n):n}function pt(n){return n?n===429||n>=500:!0}function z(n){if(typeof(n==null?void 0:n.output_text)=="string")return n.output_text;if(!Array.isArray(n==null?void 0:n.output))throw new Error("OpenAI response did not include output text.");let t=[];for(let s of n.output)if((s==null?void 0:s.type)==="message"&&Array.isArray(s.content))for(let i of s.content)(i==null?void 0:i.type)==="output_text"&&typeof i.text=="string"&&t.push(i.text);let e=t.join("");if(!e)throw new Error("OpenAI response did not include output text.");return e}function O(n){var e,s,i;let t=(i=(s=(e=n==null?void 0:n.choices)==null?void 0:e[0])==null?void 0:s.message)==null?void 0:i.content;if(typeof t!="string")throw new Error("Azure response did not include output text.");return t}function lt(n,t){let e=t.trimEnd();if(!e)return n;let s=n.match(/^---\r?\n[\s\S]*?\r?\n---\r?\n?/);if(!s)return`${e}
>>>>>>> origin/codex/update-naming-convention-for-pictures

${n}`;let i=s[0],r=n.slice(i.length),o=r.startsWith(`
`)?`
`:`

`;return`${i}${e}${o}${r}`}function S(n){if(n instanceof m)return"Ink2Markdown cancelled.";if(n instanceof g){let t=n.status?` (HTTP ${n.status})`:"";return`${n.provider==="openai"?"OpenAI":"Azure OpenAI"} error${t}: ${n.message}`}return n instanceof Error&&n.message||"Unexpected error."}function ht(n){let t=String(n.getFullYear()),e=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0"),i=String(n.getHours()).padStart(2,"0"),r=String(n.getMinutes()).padStart(2,"0"),o=String(n.getSeconds()).padStart(2,"0");return`${t}-${e}-${s} ${i}${r}${o}`}function gt(n){var s,i;let t=(s=n.name)==null?void 0:s.trim();if(t&&t.includes(".")){let r=t.split(".").pop();if(r)return r.toLowerCase()}switch((i=n.type)==null?void 0:i.toLowerCase()){case"image/png":return"png";case"image/webp":return"webp";case"image/gif":return"gif";case"image/heic":return"heic";case"image/heif":return"heif";case"image/tiff":return"tiff";case"image/bmp":return"bmp";default:return"jpg"}}function ft(n,t){let e=t.trim();if(!e)return n;if(!n)return`${e}
`;let s=`
`;return n.endsWith(`

`)?s="":n.endsWith(`
`)?s=`
`:s=`

`,`${n}${s}${e}
`}
