"use strict";var k=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var J=(e,t)=>{for(var n in t)k(e,n,{get:t[n],enumerable:!0})},q=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of F(t))!H.call(e,i)&&i!==n&&k(e,i,{get:()=>t[i],enumerable:!(s=j(t,i))||s.enumerable});return e};var G=e=>q(k({},"__esModule",{value:!0}),e);var lt={};J(lt,{default:()=>A});module.exports=G(lt);var o=require("obsidian"),O="Role: You are an OCR + formatting engine. Your job is to transcribe handwritten/printed notes into valid Obsidian-compatible Markdown with maximum accuracy. Output only Markdown. Do not add commentary.",D=`Task: Transcribe the provided page image into clean, normalized Markdown for Obsidian.
Rules (follow strictly):
1. Output only Markdown (no code fences, no explanations).
2. Normalize: if the author wrote Markdown syntax imperfectly but intent is clear, output the correct Markdown.
3. Headings: Treat headings when the author wrote leading # marks (#, ##, ###, etc.). Do not infer headings from underlines.
4. Bullets & numbering: Detect bullet and numbered lists even if written as 1), 1., or 1 etc.
5. Indentation: Infer nested lists from visual indentation.
6. Checkboxes: Treat drawn checkboxes or [ ] / [x] as Markdown task items (- [ ] / - [x]).
7. Highlights: Preserve ==highlight== syntax only when the author explicitly wrote ==...==.
8. Horizontal rules: A straight line spanning at least ~50% of the page width should become a Markdown horizontal rule: ---.
9. Line breaks: Prefer semantic paragraphs; do not preserve arbitrary line breaks from handwriting if it\u2019s clearly the same sentence.
10. Illegible text: If any word/phrase is unreadable, insert exactly ==ILLEGIBLE== in its place.
11. No extras: Do not invent tags, links, callouts, or tables. Do not summarize.`,R=`You will be given multiple chunks of Markdown transcribed from sequential pages of the same note.
Goal: Produce a single, continuous, cleaned-up Markdown note with consistent formatting.
Rules:
1. Only output Markdown.
2. Preserve the author\u2019s wording. You may correct obvious OCR mistakes only when the surrounding context makes the correction highly confident.
3. Fix list continuity, indentation, and numbering.
4. Merge sentences split across page boundaries.
5. Prefer semantic paragraphs.
6. Do not add page separators.
7. Preserve ==ILLEGIBLE== markers as-is.`,Y=["gpt-5.2","gpt-5.2-pro","gpt-5.2-chat-latest","gpt-5.1","gpt-5","gpt-5-mini","gpt-5-nano","gpt-5-chat-latest"],W={provider:"openai",systemPrompt:O,extractionPrompt:D,cleanupPrompt:R,openaiApiKey:"",openaiModel:"gpt-5.2",azureEndpoint:"",azureDeployment:"",azureApiVersion:"",azureApiKey:""},X=3,Q=6e4,Z={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/webp",gif:"image/gif",heic:"image/heic",heif:"image/heif",tif:"image/tiff",tiff:"image/tiff",bmp:"image/bmp"},d=class extends Error{constructor(){super("Ink2Markdown cancelled")}},g=class extends Error{constructor(t,n,s){super(n),this.provider=t,this.status=s}},f=class{constructor(){this.cancelled=!1;this.controllers=new Set}cancel(){this.cancelled=!0;for(let t of this.controllers)t.abort();this.controllers.clear()}register(t){if(this.cancelled){t.abort();return}this.controllers.add(t)}unregister(t){this.controllers.delete(t)}},b=class extends o.Modal{constructor(t,n,s){super(t),this.total=n,this.token=s}onOpen(){let{contentEl:t}=this;t.addClass("ink2markdown-progress"),this.statusEl=t.createEl("div",{cls:"ink2markdown-status",text:"Starting..."}),this.progressEl=t.createEl("progress",{cls:"ink2markdown-progressbar"}),this.progressEl.max=100,this.progressEl.value=0,this.cancelButton=t.createEl("button",{text:"Cancel",cls:"mod-warning"}),this.cancelButton.addEventListener("click",()=>{this.cancelButton.disabled=!0,this.setStatus("Cancelling..."),this.token.cancel()})}onClose(){this.contentEl.empty()}setStatus(t){this.statusEl.setText(t)}setProgress(t){let n=this.total===0?0:Math.round(t/this.total*100);this.progressEl.value=n}},w=class extends o.Modal{constructor(n,s){super(n);this.resolved=!1;this.resolve=s}onOpen(){let{contentEl:n}=this;n.addClass("ink2markdown-disclosure"),n.createEl("h2",{text:"Ink2Markdown Privacy Disclosure"}),n.createEl("p",{text:"Ink2Markdown sends your embedded note images to the configured AI provider for transcription."}),n.createEl("p",{text:"Do not use with sensitive/confidential information unless you accept this."});let s=n.createEl("div",{cls:"ink2markdown-buttons"}),i=s.createEl("button",{text:"I Understand",cls:"mod-cta"}),r=s.createEl("button",{text:"Cancel"});i.addEventListener("click",()=>this.finish(!0)),r.addEventListener("click",()=>this.finish(!1))}onClose(){this.resolved||this.finish(!1)}finish(n){this.resolved||(this.resolved=!0,this.resolve(n),this.close())}},v=class{constructor(t){this.apiKey=t.openaiApiKey.trim(),this.model=t.openaiModel.trim()}async transcribePage(t,n,s){let i={model:this.model,instructions:n.systemPrompt,input:[{role:"user",content:[{type:"input_text",text:n.extractionPrompt},{type:"input_image",image_url:t}]}]},r=await y("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"openai");return I(r)}async cleanup(t,n,s){let i={model:this.model,instructions:n.systemPrompt,input:[{role:"user",content:[{type:"input_text",text:n.cleanupPrompt},{type:"input_text",text:t}]}]},r=await y("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"openai");return I(r)}async testConnection(t){let n={model:this.model,input:"ping"};await y("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(n)},t,"openai")}},P=class{constructor(t){this.endpoint=t.azureEndpoint.trim().replace(/\/+$/,""),this.deployment=t.azureDeployment.trim(),this.apiVersion=t.azureApiVersion.trim(),this.apiKey=t.azureApiKey.trim()}async transcribePage(t,n,s){let i={messages:[{role:"system",content:n.systemPrompt},{role:"user",content:[{type:"text",text:n.extractionPrompt},{type:"image_url",image_url:{url:t}}]}]},r=await y(`${this.endpoint}/openai/deployments/${encodeURIComponent(this.deployment)}/chat/completions?api-version=${encodeURIComponent(this.apiVersion)}`,{method:"POST",headers:{"api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"azure");return z(r)}async cleanup(t,n,s){let i={messages:[{role:"system",content:n.systemPrompt},{role:"user",content:[{type:"text",text:`${n.cleanupPrompt}

${t}`}]}]},r=await y(`${this.endpoint}/openai/deployments/${encodeURIComponent(this.deployment)}/chat/completions?api-version=${encodeURIComponent(this.apiVersion)}`,{method:"POST",headers:{"api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify(i)},s,"azure");return z(r)}async testConnection(t){let n={messages:[{role:"user",content:"ping"}]};await y(`${this.endpoint}/openai/deployments/${encodeURIComponent(this.deployment)}/chat/completions?api-version=${encodeURIComponent(this.apiVersion)}`,{method:"POST",headers:{"api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify(n)},t,"azure")}},A=class extends o.Plugin{async onload(){await this.loadSettings(),this.addCommand({id:"ink2markdown-convert",name:"Ink2Markdown: Convert embedded images to Markdown",callback:()=>this.runConversion()}),this.addSettingTab(new T(this.app,this))}async runConversion(){let t=this.app.workspace.getActiveFile();if(!t){new o.Notice("No active note found.");return}let n=await this.app.vault.read(t),s=tt(n);if(s.length===0){new o.Notice("No embedded images found in note.");return}let i=E(this.settings);if(i){new o.Notice(i);return}if(!await this.ensurePrivacyAccepted())return;let a={systemPrompt:this.settings.systemPrompt,extractionPrompt:this.settings.extractionPrompt,cleanupPrompt:this.settings.cleanupPrompt},c=this.settings.provider==="openai"?new v(this.settings):new P(this.settings),p=new f,u=new b(this.app,s.length,p);u.open();try{let l=0;u.setProgress(l);let m=s.map((U,_)=>async()=>{if(p.cancelled)throw new d;u.setStatus(`Processing image ${_+1} of ${s.length}...`);let K=await this.loadImageDataUrl(t,U.linkpath),V=await c.transcribePage(K,a,p);return l+=1,u.setProgress(l),V}),h=await rt(m,X,p);if(p.cancelled)throw new d;u.setStatus("Final formatting cleanup...");let N=h.join(`

`),B=await c.cleanup(N,a,p);if(p.cancelled)throw new d;let L=pt(n,B.trimEnd());await this.app.vault.modify(t,L),u.close(),new o.Notice("Inserted Markdown transcription at top of note.")}catch(l){p.cancel(),u.close(),new o.Notice(M(l))}}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},W,t)}async saveSettings(){await this.saveData(this.settings)}async ensurePrivacyAccepted(){if(this.settings.privacyAcceptedAt)return!0;let t=await new Promise(n=>{new w(this.app,n).open()});return t&&(this.settings.privacyAcceptedAt=Date.now(),await this.saveSettings()),t}async loadImageDataUrl(t,n){if(it(n))throw new Error("Embedded image must be a local vault file.");let s=this.app.metadataCache.getFirstLinkpathDest(n,t.path);if(!s)throw new Error(`Image not found in vault: ${n}`);let i=s.extension.toLowerCase(),r=Z[i];if(!r)throw new Error(`Unsupported image format: .${i}`);let a=await this.app.vault.readBinary(s),c=st(a);return`data:${r};base64,${c}`}async testConnection(){let t=E(this.settings);if(t){new o.Notice(t);return}let n=this.settings.provider==="openai"?new v(this.settings):new P(this.settings),s=new f;try{await n.testConnection(s),new o.Notice("Connection successful.")}catch(i){new o.Notice(M(i))}}},T=class extends o.PluginSettingTab{constructor(t,n){super(t,n),this.plugin=n}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Ink2Markdown Settings"}),new o.Setting(t).setName("Provider").setDesc("Choose OpenAI or Azure OpenAI.").addDropdown(i=>{i.addOption("openai","OpenAI").addOption("azure","Azure OpenAI").setValue(this.plugin.settings.provider).onChange(async r=>{this.plugin.settings.provider=r,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.provider==="openai"&&(new o.Setting(t).setName("OpenAI API key").setDesc("Stored locally in plaintext as requested.").addText(i=>{i.inputEl.type="password",i.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async r=>{this.plugin.settings.openaiApiKey=r.trim(),await this.plugin.saveSettings()})}),new o.Setting(t).setName("OpenAI model").setDesc("GPT-5 family models that support image input.").addDropdown(i=>{for(let r of Y)i.addOption(r,r);i.setValue(this.plugin.settings.openaiModel).onChange(async r=>{this.plugin.settings.openaiModel=r,await this.plugin.saveSettings()})})),this.plugin.settings.provider==="azure"&&(new o.Setting(t).setName("Azure endpoint").setDesc("Example: https://{resource}.openai.azure.com").addText(i=>{i.setPlaceholder("https://example.openai.azure.com").setValue(this.plugin.settings.azureEndpoint).onChange(async r=>{this.plugin.settings.azureEndpoint=r.trim(),await this.plugin.saveSettings()})}),new o.Setting(t).setName("Azure deployment name").setDesc("Vision-enabled deployment name").addText(i=>{i.setPlaceholder("deployment-name").setValue(this.plugin.settings.azureDeployment).onChange(async r=>{this.plugin.settings.azureDeployment=r.trim(),await this.plugin.saveSettings()})}),new o.Setting(t).setName("Azure API version").setDesc("Example: 2024-02-15-preview").addText(i=>{i.setPlaceholder("2024-02-15-preview").setValue(this.plugin.settings.azureApiVersion).onChange(async r=>{this.plugin.settings.azureApiVersion=r.trim(),await this.plugin.saveSettings()})}),new o.Setting(t).setName("Azure API key").setDesc("Stored locally in plaintext as requested.").addText(i=>{i.inputEl.type="password",i.setPlaceholder("azure-key").setValue(this.plugin.settings.azureApiKey).onChange(async r=>{this.plugin.settings.azureApiKey=r.trim(),await this.plugin.saveSettings()})})),new o.Setting(t).setName("Test connection").setDesc("Validate your current provider credentials and settings.").addButton(i=>{i.setButtonText("Test connection").onClick(async()=>{i.setDisabled(!0),i.setButtonText("Testing..."),await this.plugin.testConnection(),i.setButtonText("Test connection"),i.setDisabled(!1)})}),t.createEl("h3",{text:"Prompts"}),x(t,"System prompt","Shared system prompt for extraction and cleanup.",this.plugin.settings.systemPrompt,async i=>{this.plugin.settings.systemPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.systemPrompt=O,await this.plugin.saveSettings(),this.display()},"Reset System Prompt"),x(t,"Extraction prompt","Prompt used for per-page transcription.",this.plugin.settings.extractionPrompt,async i=>{this.plugin.settings.extractionPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.extractionPrompt=D,await this.plugin.saveSettings(),this.display()},"Reset Extraction Prompt"),x(t,"Cleanup prompt","Prompt used for final formatting cleanup.",this.plugin.settings.cleanupPrompt,async i=>{this.plugin.settings.cleanupPrompt=i,await this.plugin.saveSettings()},async()=>{this.plugin.settings.cleanupPrompt=R,await this.plugin.saveSettings(),this.display()},"Reset Cleanup Prompt"),t.createEl("h3",{text:"Privacy disclosure"});let n=this.plugin.settings.privacyAcceptedAt,s=n?`Accepted on ${new Date(n).toLocaleString()}`:"Not accepted";new o.Setting(t).setName("Disclosure status").setDesc(s).addButton(i=>{i.setButtonText("Review disclosure").onClick(async()=>{await new Promise(a=>{new w(this.app,a).open()})&&!this.plugin.settings.privacyAcceptedAt&&(this.plugin.settings.privacyAcceptedAt=Date.now(),await this.plugin.saveSettings(),this.display())})})}};function x(e,t,n,s,i,r,a){let c=new o.Setting(e).setName(t).setDesc(n);c.addTextArea(p=>{p.setValue(s).onChange(async u=>{await i(u)}),p.inputEl.rows=6}),c.addButton(p=>{p.setButtonText(a).onClick(async()=>{await r()})})}function E(e){if(e.provider==="openai"){if(!e.openaiApiKey.trim())return"Missing OpenAI API key.";if(!e.openaiModel.trim())return"Missing OpenAI model selection."}else{if(!e.azureEndpoint.trim())return"Missing Azure endpoint.";if(!e.azureDeployment.trim())return"Missing Azure deployment name.";if(!e.azureApiVersion.trim())return"Missing Azure API version.";if(!e.azureApiKey.trim())return"Missing Azure API key."}return null}function tt(e){let t=[],n=/!\[\[([^\]]+)\]\]|!\[[^\]]*\]\(([^)]+)\)/g,s;for(;(s=n.exec(e))!==null;){let i=s[1],r=s[2];if(i){let a=et(i);a&&t.push({linkpath:a});continue}if(r){let a=nt(r);a&&t.push({linkpath:a})}}return t}function et(e){let t=e.trim(),n=t.indexOf("|");return n!==-1&&(t=t.slice(0,n)),t=$(t),t.trim()}function nt(e){let t=e.trim();t.startsWith("<")&&t.endsWith(">")&&(t=t.slice(1,-1));let n=t.match(/^(.*?)(\s+["'].*["'])$/);return n&&(t=n[1]),t=$(t),t.trim()}function $(e){let t=e.indexOf("#");t!==-1&&(e=e.slice(0,t));let n=e.indexOf("^");return n!==-1&&(e=e.slice(0,n)),e}function it(e){return/^(https?:\/\/|data:|app:|obsidian:)/i.test(e.trim())}function st(e){if(typeof Buffer!="undefined")return Buffer.from(e).toString("base64");let t="",n=new Uint8Array(e),s=32768;for(let i=0;i<n.length;i+=s)t+=String.fromCharCode(...n.subarray(i,i+s));return btoa(t)}async function rt(e,t,n){let s=new Array(e.length),i=0,r=0,a=0,c=!1;return new Promise((p,u)=>{let l=()=>{if(!c){if(n.cancelled){c=!0,u(new d);return}for(;i<t&&r<e.length;){let m=r++;i+=1,e[m]().then(h=>{s[m]=h,a+=1}).catch(h=>{c||(c=!0,n.cancel(),u(h))}).finally(()=>{i-=1,c||(a===e.length?p(s):l())})}}};l()})}async function y(e,t,n,s){let r=null;for(let a=1;a<=2;a+=1)try{return await ot(e,t,n,s)}catch(c){if(r=c,n.cancelled)throw new d;if(c instanceof g){if(!ct(c.status)||a===2)throw c}else if(a===2)throw c}throw r}async function ot(e,t,n,s){var r,a,c;let i=null;try{if(n.cancelled)throw new d;let p=at(t.headers),u=typeof t.body=="string"?t.body:t.body?String(t.body):void 0,l=await Promise.race([(0,o.requestUrl)({url:e,method:(r=t.method)!=null?r:"GET",headers:p,body:u,throw:!1}),new Promise((m,h)=>{i=setTimeout(()=>{h(new g(s,"Request timed out."))},Q)})]);if(n.cancelled)throw new d;if(l.status<200||l.status>=300){let m=(a=S(l.json))!=null?a:S(C(l.text));throw new g(s,m!=null?m:`${s.toUpperCase()} error (${l.status}).`,l.status)}return(c=l.json)!=null?c:C(l.text)}catch(p){throw n.cancelled?new d:p instanceof g?p:p instanceof Error&&/timed out|timeout/i.test(p.message)?new g(s,"Request timed out."):new g(s,"Network error while contacting provider.")}finally{i&&clearTimeout(i)}}function C(e){if(!e)return null;try{return JSON.parse(e)}catch(t){return null}}function S(e){var t;return e?(t=e==null?void 0:e.error)!=null&&t.message?e.error.message:e!=null&&e.message?e.message:null:null}function at(e){if(!e)return{};if(e instanceof Headers){let t={};return e.forEach((n,s)=>{t[s]=n}),t}return Array.isArray(e)?Object.fromEntries(e):e}function ct(e){return e?e===429||e>=500:!0}function I(e){if(typeof(e==null?void 0:e.output_text)=="string")return e.output_text;if(!Array.isArray(e==null?void 0:e.output))throw new Error("OpenAI response did not include output text.");let t=[];for(let s of e.output)if((s==null?void 0:s.type)==="message"&&Array.isArray(s.content))for(let i of s.content)(i==null?void 0:i.type)==="output_text"&&typeof i.text=="string"&&t.push(i.text);let n=t.join("");if(!n)throw new Error("OpenAI response did not include output text.");return n}function z(e){var n,s,i;let t=(i=(s=(n=e==null?void 0:e.choices)==null?void 0:n[0])==null?void 0:s.message)==null?void 0:i.content;if(typeof t!="string")throw new Error("Azure response did not include output text.");return t}function pt(e,t){let n=t.trimEnd();if(!n)return e;let s=e.match(/^---\r?\n[\s\S]*?\r?\n---\r?\n?/);if(!s)return`${n}

${e}`;let i=s[0],r=e.slice(i.length),a=r.startsWith(`
`)?`
`:`

`;return`${i}${n}${a}${r}`}function M(e){if(e instanceof d)return"Ink2Markdown cancelled.";if(e instanceof g){let t=e.status?` (HTTP ${e.status})`:"";return`${e.provider==="openai"?"OpenAI":"Azure OpenAI"} error${t}: ${e.message}`}return e instanceof Error&&e.message||"Unexpected error."}
